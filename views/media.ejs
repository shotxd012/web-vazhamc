<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <style>
        .comment-toggle {
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<%- include('partials/nav') %>
<%- include('partials/message') %>

<!-- Alert Message -->
<div id="custom-alert" class="fixed top-6 right-6 z-50 hidden opacity-0 translate-x-5 bg-gray-900 border-l-4 border-emerald-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 transition-all duration-300 ease-in-out">
    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 17a5 5 0 100-10 5 5 0 000 10z"/>
    </svg>
    <span id="alert-message" class="text-sm"></span>
</div>

<section class="py-20">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-center text-emerald-400">Community Media</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <% media.forEach(item => { %>
                <div class="relative rounded-lg overflow-hidden shadow-lg bg-gray-800">
                    <img src="<%= item.imageUrl %>" alt="Media" class="w-full h-64 object-cover">

                    <!-- User Info -->
                    <div class="absolute top-2 right-2 bg-gray-900 bg-opacity-75 rounded-lg px-3 py-1 flex items-center space-x-2">
                        <img src="https://cdn.discordapp.com/avatars/<%= item.discordId %>/<%= item.avatar %>.png" class="w-8 h-8 rounded-full border-2 border-emerald-500">
                        <span class="text-sm font-semibold"><%= item.username %></span>
                    </div>

                    <!-- Description -->
                    <div class="px-4 py-2">
                        <% if (item.description) { %>
                            <p class="text-sm text-gray-300 italic"><%= item.description %></p>
                        <% } %>
                    </div>

                    <!-- Likes/Dislikes -->
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-900">
                        <div class="flex items-center space-x-3">
                            <button onclick="vote('<%= item._id %>', 'like')" class="text-green-400 hover:text-green-600">
                                üëç <span id="like-<%= item._id %>"><%= item.likes || 0 %></span>
                            </button>
                            <button onclick="vote('<%= item._id %>', 'dislike')" class="text-red-400 hover:text-red-600">
                                üëé <span id="dislike-<%= item._id %>"><%= item.dislikes || 0 %></span>
                            </button>
                        </div>
                        <button onclick="toggleComments('<%= item._id %>')" class="text-sm text-emerald-400 hover:text-emerald-600">üí¨ Comments</button>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-<%= item._id %>" class="px-4 py-2 space-y-2 bg-gray-900 hidden comment-toggle">
                        <% const mediaComments = comments.filter(c => c.mediaId === item._id.toString()); %>
                        <% mediaComments.forEach(comment => { %>
                            <div class="flex items-start space-x-2">
                                <img src="https://cdn.discordapp.com/avatars/<%= comment.userId %>/<%= comment.avatar %>.png" class="w-8 h-8 rounded-full">
                                <div>
                                    <p class="text-sm font-semibold text-emerald-400"><%= comment.username %></p>
                                    <p class="text-sm text-gray-300 bg-gray-700 px-3 py-1 rounded-lg inline-block mt-1"><%= comment.message %></p>
                                </div>
                            </div>
                        <% }) %>

                        <% if (user) { %>
                            <form onsubmit="return submitComment(event, '<%= item._id %>')" class="flex items-center space-x-2 mt-2">
                                <input type="text" name="message" id="comment-<%= item._id %>" placeholder="Write a comment..." required
                                       class="flex-1 px-3 py-2 rounded bg-gray-700 text-sm text-white focus:outline-none">
                                <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-1 rounded text-sm">Send</button>
                            </form>
                        <% } else { %>
                            <p class="text-sm text-gray-400 italic">Login to write a comment.</p>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</section>

<%- include('partials/footer') %>

<script>
    async function vote(id, type) {
        const res = await fetch(`/media/vote/${id}/${type}`, {
            method: "POST",
            credentials: "include"
        });

        const data = await res.json();
        if (data.success) {
            document.getElementById(`${type}-${id}`).textContent = data.count;
            showAlert("Thank you for your feedback!");
        } else {
            showAlert(data.message || "Error voting");
        }
    }

    async function submitComment(event, mediaId) {
        event.preventDefault();
        const input = document.getElementById(`comment-${mediaId}`);
        const message = input.value.trim();
        if (!message) return;

        const res = await fetch(`/media/comment/${mediaId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ message })
        });

        const data = await res.json();
        if (data.success) {
            location.reload();
        } else {
            showAlert(data.message || "Failed to comment");
        }
    }

    function toggleComments(id) {
        const section = document.getElementById(`comments-${id}`);
        section.classList.toggle("hidden");
    }

    function showAlert(message) {
        const alertBox = document.getElementById("custom-alert");
        const alertText = document.getElementById("alert-message");

        alertText.textContent = message;
        alertBox.classList.remove("hidden");
        alertBox.classList.add("opacity-100");

        setTimeout(() => {
            alertBox.classList.add("hidden");
            alertBox.classList.remove("opacity-100");
        }, 3000);
    }
</script>
</body>
</html>
